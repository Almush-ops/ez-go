---
import BaseLayout from '@/layouts/BaseLayout.astro';
import Breadcrumbs from '@/components/Breadcrumbs.astro';
import ContactForm from '@/components/ContactForm.astro';
import FAQ from '@/components/FAQ.astro';
import SchemaOrg from '@/components/SchemaOrg.astro';
import { getCollection } from 'astro:content';

export async function getStaticPaths() {
  const blogPosts = await getCollection('blog');
  return blogPosts.map((post) => ({
    params: { slug: post.data.slug || post.id.replace(/\.md$/, '') },
    props: { post },
  }));
}

// Helper to get slug consistently
function getSlug(post: any): string {
  return post.data.slug || post.id.replace(/\.md$/, '');
}

const { post } = Astro.props;
const { Content } = await post.render();

const breadcrumbs = [
  { label: 'מאמרים', href: '/blog/' },
  { label: post.data.title },
];

// Category labels
const categoryLabels: Record<string, string> = {
  comparisons: 'השוואות',
  guides: 'מדריכים',
  uses: 'שימושים',
  technical: 'טכני',
  info: 'מידע',
};

// Format date
function formatDate(dateStr: string): string {
  const date = new Date(dateStr);
  return date.toLocaleDateString('he-IL', {
    year: 'numeric',
    month: 'long',
    day: 'numeric',
  });
}

// Article Schema
const articleSchema = {
  '@context': 'https://schema.org',
  '@type': 'Article',
  headline: post.data.title,
  description: post.data.description,
  image: post.data.image || 'https://ez-go.co.il/images/models/express-4-main.webp',
  datePublished: post.data.date,
  dateModified: post.data.date,
  author: {
    '@type': 'Organization',
    name: 'EZ-GO Israel',
    url: 'https://ez-go.co.il',
  },
  publisher: {
    '@type': 'Organization',
    name: 'EZ-GO Israel',
    logo: {
      '@type': 'ImageObject',
      url: 'https://ez-go.co.il/logo.png',
    },
  },
  mainEntityOfPage: {
    '@type': 'WebPage',
    '@id': `https://ez-go.co.il/blog/${getSlug(post)}/`,
  },
};

// FAQ Schema (if exists)
const faqSchema = post.data.faq && post.data.faq.length > 0 ? {
  '@context': 'https://schema.org',
  '@type': 'FAQPage',
  mainEntity: post.data.faq.map((item: { question: string; answer: string }) => ({
    '@type': 'Question',
    name: item.question,
    acceptedAnswer: {
      '@type': 'Answer',
      text: item.answer,
    },
  })),
} : null;

// Get related posts (same category, excluding current)
const allPosts = await getCollection('blog');
const relatedPosts = allPosts
  .filter(p => p.data.category === post.data.category && getSlug(p) !== getSlug(post))
  .slice(0, 3);
---

<BaseLayout
  title={`${post.data.title} | EZ-GO Israel`}
  description={post.data.description}
  image={post.data.image}
>
  <SchemaOrg schema={articleSchema} />
  {faqSchema && <SchemaOrg schema={faqSchema} />}

  <!-- Hero -->
  <section class="bg-gradient-to-bl from-ezgo-900 via-ezgo-800 to-dark text-white py-12 md:py-16">
    <div class="max-w-4xl mx-auto px-4">
      <Breadcrumbs items={breadcrumbs} />
      <div class="mt-6">
        <div class="flex items-center gap-3 mb-4">
          <span class="text-xs font-medium px-3 py-1 bg-white/10 rounded-full">
            {categoryLabels[post.data.category]}
          </span>
          <time class="text-sm text-gray-400">{formatDate(post.data.date)}</time>
        </div>
        <h1 class="text-3xl md:text-4xl lg:text-5xl font-bold mb-4">{post.data.title}</h1>
        <p class="text-xl text-gray-300">{post.data.description}</p>
      </div>
    </div>
  </section>

  <!-- Featured Image -->
  {post.data.image && (
    <section class="bg-white py-8">
      <div class="max-w-4xl mx-auto px-4">
        <img
          src={post.data.image}
          alt={post.data.title}
          class="w-full rounded-xl shadow-lg"
          loading="eager"
        />
      </div>
    </section>
  )}

  <!-- Article Content -->
  <article class="py-12 md:py-16 bg-white">
    <div class="max-w-4xl mx-auto px-4">
      <div class="prose prose-lg prose-ezgo max-w-none">
        <Content />
      </div>
    </div>
  </article>

  <!-- FAQ Section -->
  {post.data.faq && post.data.faq.length > 0 && (
    <section class="py-12 md:py-16 bg-surface">
      <div class="max-w-3xl mx-auto px-4">
        <FAQ items={post.data.faq} title="שאלות נפוצות" />
      </div>
    </section>
  )}

  <!-- Related Posts -->
  {relatedPosts.length > 0 && (
    <section class="py-12 md:py-16 bg-white">
      <div class="max-w-7xl mx-auto px-4">
        <h2 class="text-2xl font-bold text-dark mb-8">מאמרים קשורים</h2>
        <div class="grid md:grid-cols-3 gap-6">
          {relatedPosts.map((relatedPost) => (
            <a
              href={`/blog/${getSlug(relatedPost)}/`}
              class="group bg-surface rounded-xl p-5 border border-border hover:border-ezgo-300 hover:shadow-md transition-all"
            >
              <span class="text-xs font-medium text-ezgo-600 mb-2 block">
                {categoryLabels[relatedPost.data.category]}
              </span>
              <h3 class="font-bold text-dark group-hover:text-ezgo-600 transition-colors mb-2">
                {relatedPost.data.title}
              </h3>
              <p class="text-sm text-gray-600 line-clamp-2">{relatedPost.data.description}</p>
            </a>
          ))}
        </div>
      </div>
    </section>
  )}

  <!-- Contact CTA -->
  <section class="py-12 md:py-16 bg-ezgo-900 text-white">
    <div class="max-w-7xl mx-auto px-4">
      <div class="grid lg:grid-cols-2 gap-12 items-center">
        <div>
          <h2 class="text-3xl font-bold mb-4">יש לכם שאלות?</h2>
          <p class="text-xl text-gray-300 mb-6">
            השאירו פרטים ונחזור אליכם עם ייעוץ מקצועי בהתאם לצרכים שלכם.
          </p>
          <div class="flex items-center gap-3 text-gray-300">
            <svg class="w-6 h-6 text-ezgo-400" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
              <path stroke-linecap="round" stroke-linejoin="round" d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z" />
            </svg>
            <a href="tel:077-231-2585" class="hover:text-white transition-colors">077-231-2585</a>
          </div>
        </div>
        <div>
          <ContactForm title="לייעוץ ומידע נוסף" />
        </div>
      </div>
    </div>
  </section>
</BaseLayout>

<style>
  /* Prose customization for EZGO brand */
  .prose-ezgo {
    --tw-prose-links: #2563eb;
    --tw-prose-headings: #0f172a;
  }

  .prose-ezgo :global(h2) {
    @apply text-2xl font-bold mt-10 mb-4 text-dark border-b border-border pb-2;
  }

  .prose-ezgo :global(h3) {
    @apply text-xl font-bold mt-8 mb-3 text-dark;
  }

  .prose-ezgo :global(a) {
    @apply text-ezgo-600 hover:text-ezgo-700 no-underline hover:underline;
  }

  .prose-ezgo :global(ul) {
    @apply my-4 space-y-2;
  }

  .prose-ezgo :global(li) {
    @apply text-gray-700;
  }

  .prose-ezgo :global(table) {
    @apply w-full my-6 border-collapse;
  }

  .prose-ezgo :global(th) {
    @apply bg-ezgo-50 text-dark font-semibold p-3 text-start border border-border;
  }

  .prose-ezgo :global(td) {
    @apply p-3 border border-border;
  }

  .prose-ezgo :global(tr:nth-child(even)) {
    @apply bg-surface;
  }

  .prose-ezgo :global(blockquote) {
    @apply border-r-4 border-ezgo-500 bg-ezgo-50 pr-4 py-3 my-6 rounded-l-lg;
  }

  .prose-ezgo :global(strong) {
    @apply text-dark font-semibold;
  }

  .prose-ezgo :global(img) {
    @apply rounded-lg my-6;
  }
</style>
